{% extends "base.html" %}

{% block title %}New Transaction - Personal Finance Accounting{% endblock %}

{% block content %}
<div class="page-header">
    <h1>New Journal Entry</h1>
</div>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<form method="POST" class="form-large" id="newEntryForm">
    <fieldset>
        <legend>Entry Details</legend>

        <div class="form-group">
            <label for="entry_date">Date:</label>
            <input type="date" id="entry_date" name="entry_date" required tabindex="2">
        </div>

        <div class="form-group account-typeahead-wrap">
            <label for="debit_account_input">Debit Account Name:</label>
            <input type="text" id="debit_account_input" autocomplete="off" placeholder="Type to search accounts" required tabindex="1">
            <input type="hidden" id="debit_account_id" name="debit_account_id" value="">
            <div class="typeahead-dropdown" id="debit_dropdown" role="listbox" aria-hidden="true"></div>
        </div>

        <div class="form-group">
            <label for="description">Description:</label>
            <input type="text" id="description" name="description" required placeholder="Brief description" tabindex="3">
        </div>

        <div class="form-group">
            <label for="amount">Amount:</label>
            <input type="number" id="amount" name="amount" step="0.01" min="0.01" required placeholder="0.00" tabindex="4">
        </div>

        <div class="form-group account-typeahead-wrap">
            <label for="credit_account_input">Credit Account Name:</label>
            <input type="text" id="credit_account_input" autocomplete="off" placeholder="Type to search accounts" required tabindex="5">
            <input type="hidden" id="credit_account_id" name="credit_account_id" value="">
            <div class="typeahead-dropdown" id="credit_dropdown" role="listbox" aria-hidden="true"></div>
        </div>
    </fieldset>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Entry</button>
        <a href="{{ url_for('transactions.list_transactions') }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
(function() {
    const accountsData = [
        {% for acc in accounts %}
        { id: {{ acc.id }}, path: {{ (acc.get_path()|camelcase)|tojson }} }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    const today = new Date();
    document.getElementById('entry_date').value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

    function setupTypeahead(inputId, hiddenId, dropdownId) {
        const input = document.getElementById(inputId);
        const hidden = document.getElementById(hiddenId);
        const dropdown = document.getElementById(dropdownId);
        let selectedPath = null;

        function showDropdown(items) {
            dropdown.innerHTML = '';
            dropdown.setAttribute('aria-hidden', 'false');
            if (items.length === 0) {
                dropdown.classList.remove('open');
                return;
            }
            items.forEach(function(acc) {
                const div = document.createElement('div');
                div.className = 'typeahead-item';
                div.setAttribute('role', 'option');
                div.textContent = acc.path;
                div.dataset.id = acc.id;
                div.dataset.path = acc.path;
                div.addEventListener('click', function() {
                    hidden.value = acc.id;
                    input.value = acc.path;
                    selectedPath = acc.path;
                    dropdown.classList.remove('open');
                    dropdown.innerHTML = '';
                    dropdown.setAttribute('aria-hidden', 'true');
                });
                dropdown.appendChild(div);
            });
            dropdown.classList.add('open');
        }

        function hideDropdown() {
            dropdown.classList.remove('open');
            dropdown.innerHTML = '';
            dropdown.setAttribute('aria-hidden', 'true');
        }

        input.addEventListener('input', function() {
            const q = (input.value || '').trim().toLowerCase();
            if (q.length === 0) {
                hidden.value = '';
                selectedPath = null;
                hideDropdown();
                return;
            }
            if (selectedPath !== null && input.value.trim() !== selectedPath) {
                hidden.value = '';
                selectedPath = null;
            }
            const matches = accountsData.filter(function(acc) {
                return acc.path.toLowerCase().indexOf(q) !== -1;
            }).slice(0, 12);
            showDropdown(matches);
        });

        input.addEventListener('focus', function() {
            const q = (input.value || '').trim().toLowerCase();
            if (q.length > 0) {
                const matches = accountsData.filter(function(acc) {
                    return acc.path.toLowerCase().indexOf(q) !== -1;
                }).slice(0, 12);
                showDropdown(matches);
            }
        });

        input.addEventListener('blur', function() {
            setTimeout(hideDropdown, 200);
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideDropdown();
            }
        });
    }

    setupTypeahead('debit_account_input', 'debit_account_id', 'debit_dropdown');
    setupTypeahead('credit_account_input', 'credit_account_id', 'credit_dropdown');

    document.getElementById('newEntryForm').addEventListener('submit', function() {
        if (!document.getElementById('debit_account_id').value || !document.getElementById('credit_account_id').value) {
            return false;
        }
        return true;
    });

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('debit_account_input').focus();
    });
})();
</script>
{% endblock %}
