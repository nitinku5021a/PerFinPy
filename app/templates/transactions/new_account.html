{% extends "base.html" %}

{% block title %}New Account - Personal Finance Accounting{% endblock %}

{% block content %}
<div class="page-header">
    <h1>New Chart of Account</h1>
</div>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<form method="POST" class="form">
    <div class="form-group">
        <label for="name">Account Name:</label>
        <input type="text" id="name" name="name" required placeholder="e.g., Cash">
    </div>
    
    <div class="form-group">
        <label for="account_type">Account Type:</label>
        <select id="account_type" name="account_type" required>
                <option value="">-- Select Type --</option>
                {% if account_types %}
                    {% for t in account_types %}
                    <option value="{{ t }}">{{ t }}</option>
                    {% endfor %}
                {% else %}
                    <option value="Asset">Asset</option>
                    <option value="Liability">Liability</option>
                    <option value="Equity">Equity</option>
                    <option value="Income">Income</option>
                    <option value="Expense">Expense</option>
                {% endif %}
            </select>
    </div>
    
    <div class="form-group">
        <label for="parent_id">Parent Account (optional for grouping):</label>
        <select id="parent_id" name="parent_id">
            <option value="">-- No Parent (Top Level) --</option>
            {% if parent_accounts %}
                {% for parent in parent_accounts %}
                <option value="{{ parent.id }}" data-type="{{ parent.account_type }}">{{ parent.name|camelcase }}</option>
                {% endfor %}
            {% endif %}
        </select>
        <small>Select a parent account to create a sub-group. Max 2 levels supported.</small>
    </div>

    <script>
    // Filter parent accounts based on selected account type
    (function(){
        const typeSelect = document.getElementById('account_type');
        const parentSelect = document.getElementById('parent_id');
        function filterParents() {
            const selectedType = typeSelect.value;
            for (const opt of parentSelect.options) {
                const optType = opt.getAttribute('data-type');
                if (!optType) continue; // top-level "No Parent"
                if (!selectedType) {
                    opt.style.display = '';
                } else {
                    opt.style.display = (optType === selectedType) ? '' : 'none';
                }
            }
            // If currently selected parent no longer matches, clear it
            if (parentSelect.value) {
                const sel = parentSelect.selectedOptions[0];
                if (sel && sel.getAttribute('data-type') !== selectedType) {
                    parentSelect.value = '';
                }
            }
        }
        typeSelect.addEventListener('change', filterParents);
        // initial filter in case of server-side preselection
        filterParents();
    })();
    </script>
    
    <div class="form-group">
        <label for="description">Description:</label>
        <textarea id="description" name="description" rows="3"></textarea>
    </div>

    <div class="form-group">
        <label for="opening_balance">Opening Balance (optional):</label>
        <input type="number" step="0.01" id="opening_balance" name="opening_balance" placeholder="0.00" value="0.00">
        <small>Enter opening balance (positive or negative). Default is 0.00.</small>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Create Account</button>
        <a href="{{ url_for('transactions.list_accounts') }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>
{% endblock %}
